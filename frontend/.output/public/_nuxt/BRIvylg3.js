import{_ as W}from"./Cv3A62oR.js";import{_ as X}from"./BIk-UJZc.js";import{_ as Y}from"./BKSQtRzV.js";import{u as H,_ as q}from"./Cg97V0GM.js";import{_ as G}from"./ClKX_v3o.js";import{g as Q,I as Z,p as ee,j as te,J as se,c as i,a as o,b as p,w as f,A as B,k as n,d as g,t as v,m as L,l as oe,F as $,r as K,K as ne,n as d,o as a,C as ae}from"./DsjOer2v.js";import{s as re}from"./B0NY7V8c.js";import"./PBMIlgjC.js";const le={class:"mb-6 flex items-center justify-between"},ie={class:"flex items-center gap-2 text-sm text-muted-foreground"},de={key:0,class:"mb-4 rounded-lg border border-destructive/50 bg-destructive/10 p-3 text-sm text-destructive"},ce={class:"flex items-center gap-3"},ue={class:"flex gap-2"},fe={key:2,class:"flex justify-center py-20"},me={class:"mx-auto max-w-2xl space-y-2"},pe={class:"w-5 text-center text-xs font-bold text-muted-foreground"},ve={class:"flex flex-1 justify-center gap-1.5"},xe=["onClick","disabled","title"],ge={class:"w-5 text-center text-xs font-bold text-muted-foreground"},be={key:0,class:"mt-8 flex justify-center"},Be=Q({__name:"[showtimeId]",setup(we){const N=Z(),C=H(),E=ee(),S=N.params.showtimeId,x=d([]),c=d(new Set),D=d(!0),y=d(!1),r=d(""),b=d(null),w=d(""),h=d(!1),_=d("");let m=null,u=null;const T=ae(()=>{const e=new Map;for(const t of x.value){const s=t.seatCode.charAt(0);e.has(s)||e.set(s,[]),e.get(s).push(t)}for(const[,t]of e)t.sort((s,k)=>parseInt(s.seatCode.substring(1))-parseInt(k.seatCode.substring(1)));return e});function j(e){return e.state==="BOOKED"?"bg-red-600/80 cursor-not-allowed":e.state==="LOCKED"&&e.lockedByUserId===E.user?.id?"bg-blue-500":e.state==="LOCKED"?"bg-amber-500 cursor-not-allowed":c.value.has(e.seatCode)?"bg-indigo-500 ring-2 ring-white/50":"bg-emerald-600 hover:bg-emerald-500 cursor-pointer"}function z(e){if(e.state!=="AVAILABLE"||r.value)return;const t=new Set(c.value);t.has(e.seatCode)?t.delete(e.seatCode):t.add(e.seatCode),c.value=t}async function R(){if(c.value.size!==0){y.value=!0,_.value="";try{const{data:e}=await C.post(`/showtimes/${S}/seats/lock`,{seats:Array.from(c.value)});r.value=e.bookingId,b.value=new Date(e.lockExpiresAt),c.value=new Set,M()}catch(e){_.value=e.response?.data?.error||"Failed to lock seats"}finally{y.value=!1}}}async function V(){if(r.value)try{await C.post(`/bookings/${r.value}/cancel`),r.value="",b.value=null,w.value="",u&&clearInterval(u)}catch(e){_.value=e.response?.data?.error||"Cancel failed"}}function M(){u&&clearInterval(u),u=re(()=>{if(!b.value)return;const e=b.value.getTime()-Date.now();if(e<=0){w.value="EXPIRED",r.value="",b.value=null,clearInterval(u);return}const t=Math.floor(e/6e4),s=Math.floor(e%6e4/1e3);w.value=`${t}:${s.toString().padStart(2,"0")}`},1e3)}function O(){const e=window.location.protocol==="https:"?"wss:":"ws:";m=new WebSocket(`${e}//${window.location.host}/ws/showtimes/${S}?token=${E.token}`),m.onopen=()=>{h.value=!0},m.onclose=()=>{h.value=!1,setTimeout(O,3e3)},m.onmessage=t=>{try{U(JSON.parse(t.data))}catch{}}}function U(e){if(e.type==="SYNC_SNAPSHOT"&&Array.isArray(e.seats)){x.value=e.seats;return}const t=x.value.findIndex(k=>k.seatCode===e.seatCode);if(t===-1)return;const s={...x.value[t]};e.type==="SEAT_LOCKED"?(s.state="LOCKED",s.lockedByUserId=e.lockedByUserId,s.lockExpiresAt=e.lockExpiresAt):e.type==="SEAT_RELEASED"?(s.state="AVAILABLE",s.lockedByUserId=null,s.lockExpiresAt=null):e.type==="SEAT_BOOKED"&&(s.state="BOOKED"),x.value[t]=s}return te(async()=>{try{const{data:e}=await C.get(`/showtimes/${S}/seats`);x.value=e}catch(e){console.error(e)}finally{D.value=!1}O()}),se(()=>{m&&(m.onclose=null,m.close()),u&&clearInterval(u)}),(e,t)=>{const s=W,k=X,A=Y,P=G,F=q;return a(),i("div",null,[o("div",le,[o("div",null,[p(s,{to:"/",class:"mb-2 inline-flex items-center text-sm text-muted-foreground hover:text-foreground"},{default:f(()=>[...t[0]||(t[0]=[g("← Back",-1)])]),_:1}),t[1]||(t[1]=o("h1",{class:"text-2xl font-bold tracking-tight"},"Select Your Seats",-1))]),o("div",ie,[o("span",{class:B([n(h)?"bg-emerald-500":"bg-red-500","h-2 w-2 rounded-full"])},null,2),g(" "+v(n(h)?"Live":"Reconnecting..."),1)])]),n(_)?(a(),i("div",de,v(n(_)),1)):L("",!0),n(r)?(a(),oe(F,{key:1,class:"mb-6 border-blue-500/30 bg-blue-500/5"},{default:f(()=>[p(P,{class:"flex items-center justify-between p-4"},{default:f(()=>[o("div",ce,[p(k,{variant:"secondary",class:"bg-blue-500/20 text-blue-400"},{default:f(()=>[...t[2]||(t[2]=[g("Locked",-1)])]),_:1}),t[3]||(t[3]=o("span",{class:"text-sm text-muted-foreground"},"Time remaining:",-1)),o("span",{class:B(["font-mono text-lg font-bold",n(w)==="EXPIRED"?"text-red-400":"text-blue-300"])},v(n(w)),3)]),o("div",ue,[p(A,{variant:"ghost",size:"sm",onClick:V},{default:f(()=>[...t[4]||(t[4]=[g("Cancel",-1)])]),_:1}),p(A,{size:"sm","as-child":""},{default:f(()=>[p(s,{to:`/checkout/${n(r)}`},{default:f(()=>[...t[5]||(t[5]=[g("Pay & Confirm →",-1)])]),_:1},8,["to"])]),_:1})])]),_:1})]),_:1})):L("",!0),n(D)?(a(),i("div",fe,[...t[6]||(t[6]=[o("div",{class:"h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"},null,-1)])])):(a(),i($,{key:3},[t[7]||(t[7]=o("div",{class:"mx-auto mb-10 max-w-lg text-center"},[o("div",{class:"mx-auto h-1 w-3/4 rounded-t-full bg-muted-foreground/30"}),o("p",{class:"mt-2 text-xs font-medium tracking-widest text-muted-foreground"},"SCREEN")],-1)),o("div",me,[(a(!0),i($,null,K(n(T),([I,J])=>(a(),i("div",{key:I,class:"flex items-center gap-3"},[o("span",pe,v(I),1),o("div",ve,[(a(!0),i($,null,K(J,l=>(a(),i("button",{key:l.seatCode,onClick:_e=>z(l),disabled:l.state==="BOOKED"||l.state==="LOCKED"&&l.lockedByUserId!==n(E).user?.id,class:B([j(l),"flex h-8 w-8 items-center justify-center rounded-t-lg text-[10px] font-semibold text-white transition-all disabled:opacity-70"]),title:l.seatCode+" - "+l.state},v(l.seatCode.substring(1)),11,xe))),128))]),o("span",ge,v(I),1)]))),128))]),t[8]||(t[8]=ne('<div class="mx-auto mt-8 flex max-w-lg flex-wrap justify-center gap-x-5 gap-y-2 text-xs text-muted-foreground"><div class="flex items-center gap-1.5"><span class="h-3 w-3 rounded-sm bg-emerald-600"></span> Available</div><div class="flex items-center gap-1.5"><span class="h-3 w-3 rounded-sm bg-indigo-500 ring-1 ring-white/50"></span> Selected</div><div class="flex items-center gap-1.5"><span class="h-3 w-3 rounded-sm bg-blue-500"></span> My Lock</div><div class="flex items-center gap-1.5"><span class="h-3 w-3 rounded-sm bg-amber-500"></span> Locked</div><div class="flex items-center gap-1.5"><span class="h-3 w-3 rounded-sm bg-red-600/80"></span> Booked</div></div>',1)),!n(r)&&n(c).size>0?(a(),i("div",be,[p(A,{size:"lg",disabled:n(y),onClick:R},{default:f(()=>[g(v(n(y)?"Locking...":`Lock ${n(c).size} Seat(s)`),1)]),_:1},8,["disabled"])])):L("",!0)],64))])}}});export{Be as default};
